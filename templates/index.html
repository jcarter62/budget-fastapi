{% extends "base.html" %}
{% block content %}
<!-- Please Wait Spinner -->
<div id="please-wait-spinner"
     style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);">
    <div style="display:flex;flex-direction:column;align-items:center;">
        <div class="loader"
             style="border:6px solid #f3f3f3;border-top:6px solid #3498db;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
        <div class="mt-2 text-gray-700 font-semibold">Please wait...</div>
    </div>
</div>
<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>
<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-4">Home - Overview</h1>
    <div class="mb-4 flex flex-wrap gap-4 items-end">
        <div>
            <label for="filter-gl" class="block text-sm font-medium">GL</label>
            <input type="text" id="filter-gl" class="border rounded px-2 py-1"
                   value={{acct5_filter}} list="gl-options">
        </div>
        <div>
            <label for="filter-desc" class="block text-sm font-medium">Description</label>
            <input id="filter-desc" type="text" class="border rounded px-2 py-1" placeholder="Search description...">
        </div>
        <div>
            <label for="filter-manager" class="block text-sm font-medium">Manager</label>
            <select id="filter-manager" class="admin-control border rounded px-2 py-1">
                <option value="">All</option>
                {% for m in managers %}
                <option value="{{m.id}}">{{m.name}}</option>
                {% endfor %}
            </select>
        </div>
        <button id="clear-filters" class="ml-2 px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">Clear</button>
    </div>
    <table class="min-w-full bg-white" id="items-table">
        <thead>
        <tr class="font-mono">
            <th style="text-align: left;">GL</th>
            <!--            <th style="text-align: left;">Line</th>-->
            <th style="text-align: right;">Budget&nbsp;</th>
            <th style="text-align: right;">Actual&nbsp;</th>
            <th style="text-align: right;">Variance&nbsp;</th>
            <th style="text-align: left;">&nbsp;Description</th>
        </tr>
        </thead>
        <tbody id="items-tbody">
        <!-- Rows will be rendered here by JS -->
        </tbody>
    </table>
</div>
<script src="/static/js/formatting.js"></script>

<script>

    function showGLDetail(gl) {
        // set local storage search parameter for /actuals url
        localStorage.setItem('actuals.filterGL', gl);
        window.location.href = '/actuals';
    }

    window.addEventListener('DOMContentLoaded', function () {
        var spinner = document.getElementById('please-wait-spinner');
        var tbody = document.getElementById('items-tbody');
        var filterGL = document.getElementById('filter-gl');
        var filterDesc = document.getElementById('filter-desc');
        var filterManager = document.getElementById('filter-manager');
        var clearBtn = document.getElementById('clear-filters');
        // Get account manager mapping for filtering
        var accountManagerMap = {};

        // load accountManagerMap using api:
        // /api/managers-for-accounts
        let url = "/api/managers-for-accounts";
        fetch(url)
            .then(function (response) {
                return response.json();
            })
            .then(function (data) {
                data.forEach(function (item) {
                    let key = item.key;
                    let mgr = item.name;
                    let thisMgr = accountManagerMap[key] || '';
                    if (thisMgr > '') {
                        mgr = thisMgr + "," + mgr;
                    }
                    accountManagerMap[key] = mgr;
                });
            })
            .catch(function (err) {
                console.error('Failed to load account-manager mapping:', err);
            });

        // Save/restore filters
        function saveFilters() {
            localStorage.setItem('home.filterGL', filterGL.value);
            localStorage.setItem('home.filterDesc', filterDesc.value);
            localStorage.setItem('home.filterManager', filterManager.value);
        }

        function restoreFilters() {
            var gl = localStorage.getItem('home.filterGL') || '';
            var desc = localStorage.getItem('home.filterDesc') || '';
            var mgr = localStorage.getItem('home.filterManager') || '';
            filterGL.value = gl;
            filterDesc.value = desc;
            filterManager.value = mgr;
        }

        function buildQuery() {
            var params = [];
            if (filterGL.value) params.push('acct5=' + encodeURIComponent(filterGL.value));
            if (filterDesc.value) params.push('description=' + encodeURIComponent(filterDesc.value));
            if (filterManager.value) params.push('manager=' + encodeURIComponent(filterManager.value));
            return params.length ? ('?' + params.join('&')) : '';
        }

        function renderRows(items) {
            tbody.innerHTML = '';
            items.forEach(function (r) {
                let managerId = accountManagerMap[r.acct5] || '';
                let tr = document.createElement('tr');
                tr.className = 'border-b';
                let actual = fmtRJColumn(r.actual);
                let budget = fmtRJColumn(r.budget);
                let variance = fmtRJColumn(r.variance);

                tr.innerHTML = `<td class="py-1 font-mono onclick-link" onclick="showGLDetail('${r.account}');">${r.account}</td>`;
                tr.innerHTML += `<td class="font-mono" style="padding-right: 0;" >${budget}</td>`;
                tr.innerHTML += `<td class="font-mono" style="padding-right: 0;" >${actual}</td>`;
                tr.innerHTML += `<td class="${r.variance >= 0 ? 'text-green-700' : 'text-red-700'} font-semibold font-mono" style="padding-right: 0;" >${variance}</td>`;
                tr.innerHTML += `<td>&nbsp;${r.description || ''}</td>`;
                tbody.appendChild(tr);
            });
        }

        function fetchAndRender() {
            if (spinner) spinner.style.display = '';
            var url = '/api/home-items' + buildQuery();
            fetch(url)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    renderRows(data);
                    if (spinner) spinner.style.display = 'none';
                })
                .catch(function (err) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-red-600">Failed to load data.</td></tr>';
                    if (spinner) spinner.style.display = 'none';
                });
        }

        // Event listeners
        filterGL.addEventListener('change', function () {
            saveFilters();
            fetchAndRender();
        });
        filterDesc.addEventListener('input', function () {
            saveFilters();
            fetchAndRender();
        });
        filterManager.addEventListener('change', function () {
            saveFilters();
            fetchAndRender();
        });
        clearBtn.addEventListener('click', function () {
            filterGL.value = '';
            filterDesc.value = '';
            if (userRole === 'admin') {
                filterManager.value = '';
            }
            saveFilters();
            fetchAndRender();
        });

        // Restore filters and fetch data on load
        restoreFilters();
        fetchAndRender();
    });
</script>
{% endblock %}
