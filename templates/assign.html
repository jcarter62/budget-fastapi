{% extends "base.html" %}
{% block content %}
<!-- Please Wait Spinner -->
<div id="please-wait-spinner"
     style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);">
    <div style="display:flex;flex-direction:column;align-items:center;">
        <div class="loader"
             style="border:6px solid #f3f3f3;border-top:6px solid #3498db;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
        <div class="mt-2 text-gray-700 font-semibold">Please wait...</div>
    </div>
</div>


<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="bg-white p-4 rounded-xl shadow">
        <h2 class="font-semibold mb-2">Managers</h2>
        <p class="text-sm text-slate-600 mb-2">Drag a manager onto one account or onto multiple selected accounts.</p>
        <ul id="managers_list" class="space-y-2">
            {% for m in managers|sort(attribute='name') %}
            <li class="px-3 py-2 rounded border bg-slate-50 cursor-move"
                draggable="true"
                data-manager-id="{{ m.id }}"
                data-manager-name="{{ m.name }}">
                {{ m.name }}
            </li>
            {% endfor %}
        </ul>
    </section>

    <section class="lg:col-span-2 bg-white p-4 rounded-xl shadow">
        <div class="flex flex-col gap-3 mb-3">
            <div class="flex items-center justify-between">
                <h2 class="font-semibold">Accounts</h2>
                <div id="assign_toast"
                     class="hidden text-sm px-2 py-1 rounded bg-emerald-100 text-emerald-900 border border-emerald-200">
                    Assigned
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
                <input id="filter_text" class="border rounded p-2" placeholder="Filter by GL or Description"/>
                <select id="filter_manager" class="border rounded p-2">
                    <option value="">All managers</option>
                    <option value="__none__">Unassigned</option>
                    {% for m in managers|sort(attribute='name') %}
                    <option value="{{ m.id }}">{{ m.name }}</option>
                    {% endfor %}
                </select>
                <div class="flex gap-2">
                    <button id="clear_filters" class="border rounded px-3">Clear</button>
                    <button id="clear_selection" class="border rounded px-3">Clear Selection</button>
                </div>
            </div>
        </div>

        <table class="w-full text-sm" id="accounts_table">
            <thead>
            <tr class="text-left border-b">
                <th class="py-1 w-8"><input type="checkbox" id="select_all"/></th>
                <th class="py-1">GL</th>
                <th>Description</th>
                <th>Manager</th>
            </tr>
            </thead>
            <tbody id="assign_tbody">
                <!-- Rows will be populated by JavaScript -->
            </tbody>
        </table>
    </section>
</div>

<script>
    let spinner = document.getElementById('please-wait-spinner');

    document.addEventListener('DOMContentLoaded', function () {
        let dragged = null;
        let tbl = document.getElementById('accounts_table');
        let filterText = document.getElementById('filter_text');
        let filterManager = document.getElementById('filter_manager');
        let clearFiltersBtn = document.getElementById('clear_filters');
        let clearSelectionBtn = document.getElementById('clear_selection');
        let selectAll = document.getElementById('select_all');
        let toast = document.getElementById('assign_toast');
        let tbody = document.getElementById('assign_tbody');

        restoreFilters();

        function saveFilters() {
            localStorage.setItem('assign.filter.text', filterText.value);
            localStorage.setItem('assign.filter.manager', filterManager.value);
        }

        function restoreFilters() {
            let txt = localStorage.getItem('assign.filter.text') || '';
            let mgr = localStorage.getItem('assign.filter.manager') || '';
            if (mgr === 'All Managers') mgr = '';

            filterText.value = txt;
            filterManager.value = mgr;
        }

        function buildQuery() {
            let params = [];
            if (filterText.value) params.push('acct5=' + encodeURIComponent(filterText.value));
            if (filterManager.value) params.push('manager=' + encodeURIComponent(filterManager.value));
            return params.length ? ('?' + params.join('&')) : '';
        }

        function renderRows(items) {
            tbody.innerHTML = '';
            items.forEach(function (r) {
                let tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.setAttribute('data-account-id', r.id);
                tr.setAttribute('data-gl', r.account);
                tr.setAttribute('data-desc', (r.description || '').toLowerCase());
                tr.innerHTML = `<td class="py-1"><input type="checkbox" class="row-select"/></td>`;
                tr.innerHTML += `<td class="py-1 font-mono">${r.account}</td>`;
                tr.innerHTML += `<td>${r.description || ''}</td>`;
                let mgrCell = `<td class="manager-cell">`;
                if (r.managers.length) {
                    r.managers.forEach(function (m) {
                        mgrCell += `<span class="inline-block px-2 py-0.5 rounded bg-slate-100 border manager-badge">${m.name}</span>`;
                    });
                }
                mgrCell += `</td>`;
                tr.innerHTML += mgrCell;
                tbody.appendChild(tr);
            });
            enableDropping();
        }

        function fetchAndRender() {
            if (spinner) spinner.style.display = '';
            var url = '/api/assign-items' + buildQuery();
            fetch(url)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    renderRows(data);
                    if (spinner) spinner.style.display = 'none';
                })
                .catch(function (err) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-red-600">Failed to load data.</td></tr>';
                    if (spinner) spinner.style.display = 'none';
                });
        }


        function showToast(msg) {
            if (!toast) return;
            toast.textContent = msg || 'Assigned';
            toast.classList.remove('hidden');
            setTimeout(function () {
                toast.classList.add('hidden');
            }, 1200);
        }

        function selectedAccountIds() {
            return Array.from(tbl.querySelectorAll('tbody .row-select:checked')).map(function (cb) {
                let tr = cb.closest('tr');
                return tr ? tr.getAttribute('data-account-id') : null;
            }).filter(Boolean);
        }

        function updateRowManager(tr, managerName, managerId) {
            let badge = tr.querySelector('.manager-cell .manager-badge');
            if (badge) {
                badge.textContent = managerName || '';
                badge.classList.remove('bg-slate-100', 'bg-red-100');
                badge.classList.add('bg-emerald-100');
                setTimeout(function () {
                    badge.classList.remove('bg-emerald-100');
                    badge.classList.add('bg-slate-100');
                }, 600);
            }
            tr.setAttribute('data-manager-id', managerId || '');
        }

        function filterRows() {
            let text = (filterText && filterText.value || '').toLowerCase().trim();
            let mgr = (filterManager && filterManager.value) || '';
            Array.from(tbl.querySelectorAll('tbody tr')).forEach(function (tr) {
                let key = tr.getAttribute('data-key') || '';
                let desc = tr.getAttribute('data-desc') || '';
                let rowMgr = tr.getAttribute('data-manager-id') || '';
                let textOk = !text || key.includes(text) || desc.includes(text);
                let mgrOk = !mgr || (mgr === '__none__' ? (rowMgr === '') : (rowMgr === mgr));
                tr.style.display = (textOk && mgrOk) ? '' : 'none';
            });
        }

        if (filterText) filterText.addEventListener('input', function () {
            saveFilters();
            fetchAndRender();
            // filterRows();
        });
        if (filterManager) filterManager.addEventListener('change', function () {
            saveFilters();
            fetchAndRender();
            // filterRows();
        });

        if (clearFiltersBtn) clearFiltersBtn.addEventListener('click', function (e) {
            e.preventDefault();
            if (filterText) filterText.value = '';
            if (filterManager) filterManager.value = '';
            saveFilters();
            fetchAndRender();
            // filterRows();
        });

        if (clearSelectionBtn) clearSelectionBtn.addEventListener('click', function (e) {
            e.preventDefault();
            tbl.querySelectorAll('tbody .row-select:checked').forEach(function (cb) {
                cb.checked = false;
                cb.closest('tr').classList.remove('bg-blue-50');
            });
            selectAll.checked = false;
        });

        if (selectAll) selectAll.addEventListener('change', function () {
            let visibleRows = Array.from(tbl.querySelectorAll('tbody tr')).filter(function (tr) {
                return tr.style.display !== 'none';
            });
            visibleRows.forEach(function (tr) {
                let cb = tr.querySelector('.row-select');
                if (cb) {
                    cb.checked = selectAll.checked;
                    tr.classList.toggle('bg-blue-50', cb.checked);
                }
            });
        });

        tbl.addEventListener('change', function (e) {
            if (e.target && e.target.classList.contains('row-select')) {
                let tr = e.target.closest('tr');
                tr.classList.toggle('bg-blue-50', e.target.checked);
            }
        });

        // Enable dragging on manager items
        document.querySelectorAll('#managers_list [draggable=true]').forEach(function (el) {
            el.addEventListener('dragstart', function (e) {
                dragged = {
                    manager_id: e.target.getAttribute('data-manager-id'),
                    manager_name: e.target.getAttribute('data-manager-name')
                };
                e.dataTransfer.setData('text/plain', JSON.stringify(dragged));
                e.dataTransfer.effectAllowed = 'copy';
            });
            el.addEventListener('dragend', function () {
                dragged = null;
            });
        });

        // Make account rows droppable
        function enableDropping() {
            document.querySelectorAll('#accounts_table tbody tr').forEach(function (row) {
                row.addEventListener('dragover', function (e) {
                    if (dragged) {
                        e.preventDefault();
                        e.dataTransfer.dropEffect = 'copy';
                        row.classList.add('bg-emerald-50');
                    }
                });
                row.addEventListener('dragleave', function () {
                    row.classList.remove('bg-emerald-50');
                });
                row.addEventListener('drop', function (e) {
                    e.preventDefault();
                    row.classList.remove('bg-emerald-50');
                    let data = dragged || (function () {
                        try {
                            return JSON.parse(e.dataTransfer.getData('text/plain') || '{}');
                        } catch (_) {
                            return {};
                        }
                    })();
                    if (!data || !data.manager_id) return;
                    let managerId = data.manager_id;
                    let managerName = data.manager_name || '';
                    let ids = selectedAccountIds();
                    if (!ids.length) {
                        ids = [row.getAttribute('data-account-id')];
                    }
                    // optimistic UI update for all ids
                    ids.forEach(function (id) {
                        let tr = tbl.querySelector('tbody tr[data-account-id="' + id + '"]');
                        if (tr) updateRowManager(tr, 'Assigning...', managerId);
                    });
                    fetch('/accounts/assign', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({account_ids: ids, manager_id: managerId})
                    }).then(function (res) {
                        return res.json();
                    }).then(function (json) {
                        if (json && json.ok) {
                            ids.forEach(function (id) {
                                let tr = tbl.querySelector('tbody tr[data-account-id="' + id + '"]');
                                if (tr) updateRowManager(tr, managerName, managerId);
                            });
                            showToast('Assigned ' + ids.length + ' account' + (ids.length > 1 ? 's' : ''));
                            fetchAndRender();
                            // filterRows();
                        } else {
                            ids.forEach(function (id) {
                                let tr = tbl.querySelector('tbody tr[data-account-id="' + id + '"]');
                                if (tr) updateRowManager(tr, 'Error', null);
                            });
                            console.error('Assign error', json && json.error);
                        }
                    }).catch(function (err) {
                        ids.forEach(function (id) {
                            let tr = tbl.querySelector('tbody tr[data-account-id="' + id + '"]');
                            if (tr) updateRowManager(tr, 'Error', null);
                        });
                        console.error('Assign request failed', err);
                    });
                });
            });
        }

        // Initial filter application using restored values
        fetchAndRender();
        // filterRows();
    });

</script>
{% endblock %}
