{% extends "base.html" %}
{% block content %}
<!-- Please Wait Spinner -->
<div id="please-wait-spinner" style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);">
  <div style="display:flex;flex-direction:column;align-items:center;">
    <div class="loader" style="border:6px solid #f3f3f3;border-top:6px solid #3498db;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
    <div class="mt-2 text-gray-700 font-semibold">Please wait...</div>
  </div>
</div>
<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
</style>
<div class="bg-white p-4 rounded-xl shadow">
  <div class="flex flex-col gap-3 mb-4">
    <div class="flex items-center justify-between">
      <h2 class="font-semibold">Budgets (Fast Entry)</h2>
      <div class="flex gap-2">
        <form method="post" action="/budgets/import" style="display:inline">
          <button type="submit" class="border rounded px-3 bg-blue-100 hover:bg-blue-200">Import Budgets</button>
        </form>
        <form method="post" action="/budgets/delete_line00" style="display:inline" onsubmit="return confirm('Delete all imported budgets (line=00)?');">
          <button type="submit" class="border rounded px-3 bg-red-100 hover:bg-red-200">Delete Imported Budgets</button>
        </form>
      </div>
      <div id="budget_toast" class="hidden text-sm px-2 py-1 rounded bg-emerald-100 text-emerald-900 border border-emerald-200">Saved</div>
    </div>
    <div class="flex flex-wrap gap-4 items-end mb-2">
      <div>
        <label for="filter-gl" class="block text-sm font-medium">GL</label>
        <select id="filter-gl" class="border rounded px-2 py-1">
          <option value="">All</option>
          {% for a in accounts %}
            <option value="{{a.key}}">{{a.key}} - {{a.description}}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="filter-desc" class="block text-sm font-medium">Description</label>
        <input id="filter-desc" type="text" class="border rounded px-2 py-1" placeholder="Search description...">
      </div>
      <div>
        <label for="filter-manager" class="block text-sm font-medium">Manager</label>
        <select id="filter-manager" class="border rounded px-2 py-1">
          <option value="">All</option>
          {% for m in managers %}
            <option value="{{m.id}}">{{m.name}}</option>
          {% endfor %}
        </select>
      </div>
      <button id="clear-filters" class="ml-2 px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">Clear</button>
    </div>
  </div>
  <table class="w-full text-sm" id="budget-table">
    <thead>
      <tr class="text-left border-b">
        <th class="py-1">GL</th>
        <th>Line</th>
        <th>Budget</th>
        <th>Description</th>
        <th>Manager</th>
      </tr>
    </thead>
    <tbody id="budget-tbody">
      <!-- Rows will be rendered here by JS -->
    </tbody>
  </table>
</div>
<script>
window.addEventListener('DOMContentLoaded', function() {
  var spinner = document.getElementById('please-wait-spinner');
  var tbody = document.getElementById('budget-tbody');
  var filterGL = document.getElementById('filter-gl');
  var filterDesc = document.getElementById('filter-desc');
  var filterManager = document.getElementById('filter-manager');
  var clearBtn = document.getElementById('clear-filters');
  // Build manager lookup
  var managerMap = {};
  {% for m in managers %}
    managerMap["{{m.id}}"] = "{{m.name}}";
  {% endfor %}

  // Save/restore filters
  function saveFilters() {
    localStorage.setItem('budgets.filterGL', filterGL.value);
    localStorage.setItem('budgets.filterDesc', filterDesc.value);
    localStorage.setItem('budgets.filterManager', filterManager.value);
  }
  function restoreFilters() {
    var gl = localStorage.getItem('budgets.filterGL') || '';
    var desc = localStorage.getItem('budgets.filterDesc') || '';
    var mgr = localStorage.getItem('budgets.filterManager') || '';
    filterGL.value = gl;
    filterDesc.value = desc;
    filterManager.value = mgr;
  }

  function buildQuery() {
    var params = [];
    if (filterGL.value) params.push('acct5=' + encodeURIComponent(filterGL.value));
    if (filterDesc.value) params.push('description=' + encodeURIComponent(filterDesc.value));
    if (filterManager.value) params.push('manager=' + encodeURIComponent(filterManager.value));
    return params.length ? ('?' + params.join('&')) : '';
  }

  function renderRows(items) {
    tbody.innerHTML = '';
    if (!items.length) {
      tbody.innerHTML = '<tr><td colspan="5" class="text-gray-500">No budget items found.</td></tr>';
      return;
    }
    items.forEach(function(r) {
      var tr = document.createElement('tr');
      tr.className = 'border-b';
      tr.innerHTML = `
        <td class="py-1 font-mono">${r.acct5}</td>
        <td class="font-mono">${r.line}</td>
        <td>$${parseFloat(r.budget).toFixed(2)}</td>
        <td>${r.budget_desc || ''}</td>
        <td>${managerMap[r.manager_id] || ''}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function fetchAndRender() {
    if (spinner) spinner.style.display = '';
    var url = '/api/budget-items' + buildQuery();
    fetch(url)
      .then(function(response) { return response.json(); })
      .then(function(data) {
        renderRows(data);
        if (spinner) spinner.style.display = 'none';
      })
      .catch(function(err) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-red-600">Failed to load data.</td></tr>';
        if (spinner) spinner.style.display = 'none';
      });
  }

  // Event listeners
  filterGL.addEventListener('change', function() { saveFilters(); fetchAndRender(); });
  filterDesc.addEventListener('input', function() { saveFilters(); fetchAndRender(); });
  filterManager.addEventListener('change', function() { saveFilters(); fetchAndRender(); });
  clearBtn.addEventListener('click', function() {
    filterGL.value = '';
    filterDesc.value = '';
    filterManager.value = '';
    saveFilters();
    fetchAndRender();
  });

  // Restore filters and fetch data on load
  restoreFilters();
  fetchAndRender();
});
</script>
{% endblock %}
