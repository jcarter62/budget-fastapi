{% extends "base.html" %}
{% block content %}
<!-- Please Wait Spinner -->
<div id="please-wait-spinner"
     style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);">
    <div style="display:flex;flex-direction:column;align-items:center;">
        <div class="loader"
             style="border:6px solid #f3f3f3;border-top:6px solid #3498db;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
        <div class="mt-2 text-gray-700 font-semibold">Please wait...</div>
    </div>
</div>

<script>
function toggleSection(id) {
  var el = document.getElementById(id);
  if (!el) return;
  var isHidden = el.style.display === 'none';
  el.style.display = isHidden ? '' : 'none';
  localStorage.setItem('section_' + id, isHidden ? 'shown' : 'hidden');
}
window.addEventListener('DOMContentLoaded', function() {
  ['accounts_section'].forEach(function(id) {
    var el = document.getElementById(id);
    if (!el) return;
    var state = localStorage.getItem('section_' + id);
    el.style.display = (state === 'hidden') ? 'none' : '';
  });
});
</script>

{% if error_message %}
<div class="mb-4 p-3 rounded bg-red-100 text-red-800 border border-red-200">
  Import failed: {{ error_message }}
</div>
{% endif %}
{% if import_summary %}
<div class="mb-4 p-3 rounded bg-green-100 text-green-800 border border-green-200">
  Import complete: {{ import_summary.total }} rows processed â€” created {{ import_summary.created }}, updated {{ import_summary.updated }}.
</div>
{% endif %}

<div class="flex items-center justify-between mb-4">
  <h2 class="text-lg font-semibold">Accounts</h2>
  <div class="flex gap-2">
    <form method="post" action="/api/accounts/import" onsubmit="return confirm('Import accounts from SQL? This will add new accounts and update descriptions of existing ones.');">
      <button class="admin-control bg-emerald-600 text-white px-3 py-1 rounded">Import from SQL</button>
    </form>
    <form method="post" action="/api/accounts/delete-all" onsubmit="return confirm('Delete ALL accounts? This cannot be undone.');">
      <button class="admin-control bg-red-600 text-white px-3 py-1 rounded">Delete All Accounts</button>
    </form>
  </div>
</div>

    <table class="w-full text-sm" id="accounts-table">
      <thead>
        <tr>
          <th><input type="text" id="filter-gl" class="border rounded p-1 w-full" placeholder="Filter GL" /></th>
          <th><input type="text" id="filter-desc" class="border rounded p-1 w-full" placeholder="Filter Description" /></th>
          <th>
            <select id="filter-manager" class="admin-control border rounded p-1 w-full">
              <option value="">All Managers</option>
              {% for m in managers|sort(attribute='name') %}
                <option value="{{m.id}}">{{m.name}}</option>
              {% endfor %}
            </select>
          </th>
        </tr>
        <tr class="text-left border-b">
            <th class="py-1">GL Account</th>
            <th>Description</th>
        </tr>
      </thead>
        <tbody id="items-tbody">
        <!-- Rows will be rendered here by JS -->
        </tbody>

    </table>
    <script>


    document.addEventListener('DOMContentLoaded', function() {
        let spinner = document.getElementById('please-wait-spinner');

        let filterGL = document.getElementById('filter-gl');
        let filterDesc = document.getElementById('filter-desc');
        let filterManager = document.getElementById('filter-manager');
        let tbody = document.getElementById('items-tbody');

        function saveFilters() {
            localStorage.setItem('accounts.filter.gl', filterGL.value);
            localStorage.setItem('accounts.filter.desc', filterDesc.value);
            localStorage.setItem('accounts.filter.manager', filterManager.value);
        }

        function restoreFilters() {
            let gl = localStorage.getItem('accounts.filter.gl') || '';
            let desc = localStorage.getItem('accounts.filter.desc') || '';
            let mgr = localStorage.getItem('accounts.filter.manager') || '';
            if ( mgr === 'All Managers' ) mgr = '';

            filterGL.value = gl;
            filterDesc.value = desc;
            filterManager.value = mgr;
        }

        function buildQuery() {
            var params = [];
            if (filterGL.value) params.push('acct5=' + encodeURIComponent(filterGL.value));
            if (filterDesc.value) params.push('description=' + encodeURIComponent(filterDesc.value));
            if (filterManager.value) params.push('manager=' + encodeURIComponent(filterManager.value));
            return params.length ? ('?' + params.join('&')) : '';
        }

        function renderRows(items) {
            tbody.innerHTML = '';
            items.forEach(function (r) {
                let tr = document.createElement('tr');
                tr.className = 'border-b';
                tr.innerHTML = `<td class="py-1 font-mono">${r.account}</td>`
                tr.innerHTML += `<td>&nbsp;${r.description || ''}</td> `;
                tbody.appendChild(tr);
            });
        }

        function fetchAndRender() {
            if (spinner) spinner.style.display = '';
            var url = '/api/account-items' + buildQuery();
            fetch(url)
                .then(function (response) {
                    return response.json();
                })
                .then(function (data) {
                    renderRows(data);
                    if (spinner) spinner.style.display = 'none';
                })
                .catch(function (err) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-red-600">Failed to load data.</td></tr>';
                    if (spinner) spinner.style.display = 'none';
                });
        }

        // Event listeners
        document.getElementById('filter-gl').addEventListener('change', function () {
            saveFilters();
            fetchAndRender();
        });
        filterDesc.addEventListener('input', function () {
            saveFilters();
            fetchAndRender();
        });
        filterManager.addEventListener('change', function () {
            saveFilters();
            fetchAndRender();
        });

        // Restore filters and fetch data on load
        restoreFilters();
        fetchAndRender();
    });
    </script>
  </div>
</section>
{% endblock %}
