{% extends "base.html" %}
{% block content %}
<!-- Please Wait Spinner -->
<div id="please-wait-spinner"
     style="position:fixed;z-index:1000;top:0;left:0;width:100vw;height:100vh;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.7);">
    <div style="display:flex;flex-direction:column;align-items:center;">
        <div class="loader"
             style="border:6px solid #f3f3f3;border-top:6px solid #3498db;border-radius:50%;width:48px;height:48px;animation:spin 1s linear infinite;"></div>
        <div class="mt-2 text-gray-700 font-semibold">Please wait...</div>
    </div>
</div>
<style>
    @keyframes spin {
        0% {
            transform: rotate(0deg);
        }
        100% {
            transform: rotate(360deg);
        }
    }
</style>
<div class="bg-white p-4 rounded-xl shadow">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Actuals</h2>
        <div class="flex items-center gap-2">
            <!-- Use plain buttons that trigger JS fetch calls -->
            <button id="import-btn" type="button" class="admin-control bg-emerald-600 text-white px-3 py-1 rounded">
                Import from SQL
            </button>
            <button id="delete-all-btn" type="button" class="admin-control bg-red-600 text-white px-3 py-1 rounded">
                Delete All Imported
            </button>
        </div>
    </div>

    <h3 class="font-semibold mb-2">All Actual Items</h3>
    <div class="mb-4 flex flex-wrap gap-4 items-end">
        <div>
            <label for="filter-gl" class="block text-xs text-gray-600">Account</label>
            <!-- Converted from <select> to text input -->
            <input id="filter-gl" type="text" class="border rounded p-2 w-full" placeholder="search GL"/>
        </div>
        <div>
            <label for="filter-desc" class="block text-xs text-gray-600">Description contains</label>
            <input id="filter-desc" type="text" class="border rounded p-2 w-full" placeholder="search description"/>
        </div>
        <div>
            <label for="filter-vendor" class="block text-xs text-gray-600">Vendor contains</label>
            <input id="filter-vendor" type="text" class="border rounded p-2 w-full" placeholder="search vendor"/>
        </div>
        <div>
            <label for="filter-manager" class="block text-xs text-gray-600">Manager</label>
            <select id="filter-manager" class="admin-control border rounded p-2 w-full">
                <option value="">(All)</option>
                {% for m in managers|sort(attribute='name') %}
                <option value="{{ m.id }}">{{ m.name }}</option>
                {% endfor %}
            </select>
        </div>
        <button id="clear-filters" class="ml-2 px-3 py-1 border rounded bg-gray-100 hover:bg-gray-200">Clear</button>
    </div>
    <table class="w-full text-sm" id="actuals-table">
        <thead>
        <tr class="text-left border-b">
            <th class="py-1" data-key="acct5">Acct</th>
            <!--        <th data-key="line">Line</th>-->
            <th data-key="amount" style="text-align: right">Amount&nbsp;</th>
            <th data-key="description">&nbsp;Description</th>
            <th data-key="tr_date">Date</th>
            <th data-key="vendor_name">Vendor</th>
            <!--        <th data-key="manager">Manager</th>-->
            <th data-key="vouchno">Vouch No</th>
        </tr>
        </thead>
        <tbody id="actuals-tbody">
        <!-- Rows will be rendered here by JS -->
        </tbody>
    </table>
</div>
<!-- Voucher lines modal -->
<div id="voucherModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white rounded-lg shadow-lg w-[90vw] overflow-auto max-h-[80vh]">
        <div class="flex items-center justify-between p-4 border-b">
            <h3 id="voucherModalTitle" class="text-lg font-semibold">Voucher Lines</h3>
            <div class="flex items-center gap-3">
                <button id="voucherModalClose" type="button" class="text-gray-600 hover:text-gray-900">Close</button>
            </div>
        </div>
        <div class="p-4">
            <div id="voucherModalContent">Loading...</div>
        </div>
    </div>
</div>

<script src="/static/js/formatting.js"></script>

<script>
    let spinner = document.getElementById('please-wait-spinner');

    window.addEventListener('DOMContentLoaded', function () {
        let tbody = document.getElementById('actuals-tbody');
        let filterGL = document.getElementById('filter-gl');
        let filterDesc = document.getElementById('filter-desc');
        let filterManager = document.getElementById('filter-manager');
        let filterVendor = document.getElementById('filter-vendor');

        let clearBtn = document.getElementById('clear-filters');
        let importBtn = document.getElementById('importBudgets00');
        let deleteBtn = document.getElementById('deleteBudgets00');
        // Build manager lookup from the Manager <select> options
        let managerMap = {};
        Array.prototype.forEach.call(filterManager && filterManager.options || [], function (opt) {
            if (opt.value) managerMap[opt.value] = opt.text;
        });


        // Save/restore filters
        function saveFilters() {
            localStorage.setItem('actuals.filterGL', filterGL.value);
            localStorage.setItem('actuals.filterDesc', filterDesc.value);
            localStorage.setItem('actuals.filterManager', filterManager.value);
            localStorage.setItem('actuals.filterVendor', filterVendor.value);
        }

        function restoreFilters() {
            let gl = localStorage.getItem('actuals.filterGL') || '';
            let desc = localStorage.getItem('actuals.filterDesc') || '';
            let mgr = localStorage.getItem('actuals.filterManager') || '';
            let vendor = localStorage.getItem('actuals.filterVendor') || '';
            filterGL.value = gl;
            filterDesc.value = desc;
            filterManager.value = mgr;
            filterVendor.value = vendor;
        }

        function buildQuery() {
            let params = [];
            if (filterGL.value) params.push('acct5=' + encodeURIComponent(filterGL.value));
            if (filterDesc.value) params.push('description=' + encodeURIComponent(filterDesc.value));
            if (filterManager.value) params.push('manager=' + encodeURIComponent(filterManager.value));
            if (filterVendor.value) params.push('vendor=' + encodeURIComponent(filterVendor.value));
            return params.length ? ('?' + params.join('&')) : '';
        }

        function renderRows(items) {
            tbody.innerHTML = '';
            if (!items.length) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-gray-500">No budget items found.</td></tr>';
                return;
            }
            items.forEach(function (r) {
                let vouchCell = '';
                if (r.vouchno) {
                    vouchCell = `<a href="#" class="voucher-link text-blue-700 underline" data-vouch="${r.vouchno}">${r.vouchno}</a>`;
                }

                let tr = document.createElement('tr');

                tr.innerHTML = `<td class="py-1 font-mono">${r.account}</td>`;
                tr.innerHTML += `<td class="font-mono" style="padding-right: 0;"> ${fmtRJColumn(r.amount)}</td>`;
                tr.innerHTML += `<td>&nbsp;${r.description || ''}</td>`;
                tr.innerHTML += `<td>${r.tr_date || ''}</td>`;
                tr.innerHTML += `<td>${r.vendor_name || ''}</td>`;
                tr.innerHTML += `<td>${vouchCell}</td>`;

                // <td class="font-mono">${r.line}</td>
                // <td>${managerMap[r.manager_id] || ''}</td>

                tbody.appendChild(tr);
            });

            // Attach click handlers to voucher links
            tbody.querySelectorAll('.voucher-link').forEach(function (el) {
                el.addEventListener('click', function (ev) {
                    ev.preventDefault();
                    var vouchno = this.getAttribute('data-vouch');
                    if (!vouchno) return;
                    showVoucherModal(vouchno);
                });
            });
        }

        function fetchAndRender() {
            if (spinner) spinner.style.display = '';
            let url = '/api/actual-items' + buildQuery();
            fetch(url)
                .then(function (response) {
                    if (!response.ok) throw new Error('HTTP ' + response.status);
                    return response.json();
                })
                .then(function (data) {
                    renderRows(data);
                    if (spinner) spinner.style.display = 'none';
                })
                .catch(function (err) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-red-600">Failed to load data.</td></tr>';
                    if (spinner) spinner.style.display = 'none';
                });
        }

        function doImportBudgets() {
            if (!confirm('Import budgets from source and insert into line 00?')) return;
            if (spinner) spinner.style.display = '';
            if (importBtn) importBtn.disabled = true;
            fetch('/api/budgets/import', {method: 'POST'})
                .then(function (resp) {
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    return resp.json().catch(function () {
                        return {};
                    });
                })
                .then(function (data) {
                    let count = (data && (data.imported || data.count)) || 0;
                    showToast('Imported ' + count + ' budget rows');
                    fetchAndRender();
                })
                .catch(function (err) {
                    showToast('Import failed: ' + err.message, true);
                })
                .finally(function () {
                    if (spinner) spinner.style.display = 'none';
                    if (importBtn) importBtn.disabled = false;
                });
        }

        function doDeleteBudgets() {
            if (!confirm('Delete all imported budgets (line=00)?')) return;
            if (spinner) spinner.style.display = '';
            if (deleteBtn) deleteBtn.disabled = true;
            fetch('/api/budgets/delete_line00', {method: 'POST'})
                .then(function (resp) {
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    return resp.json().catch(function () {
                        return {};
                    });
                })
                .then(function (data) {
                    let count = (data && (data.deleted || data.count)) || 0;
                    showToast('Deleted ' + count + ' imported budget rows');
                    fetchAndRender();
                })
                .catch(function (err) {
                    showToast('Delete failed: ' + err.message, true);
                })
                .finally(function () {
                    if (spinner) spinner.style.display = 'none';
                    if (deleteBtn) deleteBtn.disabled = false;
                });
        }

        // Event listeners
        if (importBtn) importBtn.addEventListener('click', doImportBudgets);
        if (deleteBtn) deleteBtn.addEventListener('click', doDeleteBudgets);
        // Use input event for the text field
        filterGL.addEventListener('input', function () {
            saveFilters();
            fetchAndRender();
        });

        filterDesc.addEventListener('input', function () {
            saveFilters();
            fetchAndRender();
        });

        filterManager.addEventListener('change', function () {
            saveFilters();
            fetchAndRender();
        });

        filterVendor.addEventListener('input', function () {
            saveFilters();
            fetchAndRender();
        });

        clearBtn.addEventListener('click', function () {
            filterGL.value = '';
            filterDesc.value = '';
            if (userRole === 'admin') {
                filterManager.value = '';
            }
            saveFilters();
            fetchAndRender();
        });

        // Restore filters and fetch data on load
        restoreFilters();
        fetchAndRender();
    });


    // Modify addGlLine to use the modal dialog
    function addGlLine(gl) {
        const modal = document.getElementById('add-gl-line-modal');
        const form = document.getElementById('add-gl-line-form');
        const cancelBtn = document.getElementById('cancel-add-gl-line');
        const title = document.getElementById('addGlLineForm');

        let line_url = '/api/budget/next-line/' + encodeURIComponent(gl);
        fetch(line_url, {
            method: 'GET',
            headers: {'Content-Type': 'application/json'}
        })
            .then(function (resp) {
                if (resp.ok) {
                    return resp.json();
                } else {
                    throw new Error('HTTP ' + resp.status);
                }
            })
            .then(function (data) {
                let new_line = data.next_line;
                document.getElementById('line-number').value = new_line;
            });

        // set title to include the gl
        title.textContent = 'Add GL Line for:' + gl;

        // Show the modal
        modal.classList.remove('hidden');

        // Handle form submission
        form.onsubmit = function (event) {
            event.preventDefault();

            const line = document.getElementById('line-number').value;
            const amount = document.getElementById('budget-amount').value;
            const desc = document.getElementById('description').value;

            if (!line || isNaN(amount)) {
                showToast('Please provide valid inputs', true);
                return;
            }

            // Add logging to debug the fetch request
            console.log('Sending request to /budget/add/line with payload:', {gl, line, amount, desc});

            let url = '/api/budget/add/line/';
            url += gl + '/' + line + '/' + amount + '/' + encodeURIComponent(desc || '');

            fetch(url, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
                .then(function (resp) {
                    console.log('Response received:', resp);
                    if (!resp.ok) throw new Error('HTTP ' + resp.status);
                    return resp.json();
                })
                .then(function (data) {
                    console.log('Response data:', data);
                    showToast('Added budget line ' + gl + ' ' + line);
                    fetchAndRender();
                })
                .catch(function (err) {
                    console.error('Fetch error:', err);
                    showToast('Add failed: ' + err.message, true);
                })
                .finally(function () {
                    if (spinner) spinner.style.display = 'none';
                    modal.classList.add('hidden');
                    form.reset();
                    // reload this page to reflect changes;
                    window.location.reload();
                });
        };

        // Handle cancel button
        cancelBtn.onclick = function () {
            modal.classList.add('hidden');
            form.reset();
        };
    }

    function editGlLine(gl, line) {
        // open window, allow user to edit amount and description

    }

    function deleteGlLine(gl, line) {
        if (!confirm('Are you sure you want to delete budget ' + gl + ' line ' + line + '?')) return;

        let url = '/api/budget/delete/line/' + encodeURIComponent(gl) + '/' + encodeURIComponent(line);
        fetch(url, {method: 'POST'})
            .then(function (resp) {
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                return resp.json().catch(function () {
                    return {};
                });
            })
            .finally(function () {
                window.location.reload();
            });
    }

    function showToast(msg, isError) {
        if (!toast) return;
        toast.textContent = msg;
        toast.classList.remove('hidden');
        // Toggle success/error styles
        let successClasses = ['bg-emerald-100', 'text-emerald-900', 'border-emerald-200'];
        let errorClasses = ['bg-red-100', 'text-red-900', 'border-red-200'];
        successClasses.concat(errorClasses).forEach(function (c) {
            toast.classList.remove(c);
        });
        (isError ? errorClasses : successClasses).forEach(function (c) {
            toast.classList.add(c);
        });
        setTimeout(function () {
            toast.classList.add('hidden');
        }, 3000);
    }

    // Modal logic
    let voucherModal = document.getElementById('voucherModal');
    let voucherModalContent = document.getElementById('voucherModalContent');
    let voucherModalTitle = document.getElementById('voucherModalTitle');
    document.getElementById('voucherModalClose').onclick = function () {
        voucherModal.classList.add('hidden');
        voucherModalContent.innerHTML = '';
    };
    voucherModal.onclick = function (e) {
        if (e.target === voucherModal) {
            voucherModal.classList.add('hidden');
            voucherModalContent.innerHTML = '';
        }
    };

    function showVoucherModal(vouchno) {
        voucherModal.classList.remove('hidden');
        voucherModalTitle.textContent = 'Voucher ' + vouchno;
        voucherModalContent.innerHTML = 'Loading...';
        fetch('/voucher-lines?vouchno=' + encodeURIComponent(vouchno))
            .then(function (resp) {
                return resp.text();
            })
            .then(function (html) {
                voucherModalContent.innerHTML = html;
            })
            .catch(function (err) {
                voucherModalContent.textContent = String(err);
            });
    }

</script>

{% endblock %}
